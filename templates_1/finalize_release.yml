# ===================================================================================
# ==                 README: Finalize Release - Step Template                    ==
# ===================================================================================
#
# CORRECTION (Using checkout: self):
# This version replaces the verbose 'git clone' script with the cleaner, built-in
# 'checkout: self' task.
#
# ===================================================================================

parameters:
- name: repositoryName
  type: string
- name: releaseBranchName
  type: string

steps:
- checkout: self
  persistCredentials: true

- task: Bash@3
  displayName: 'Configure Git Identity'
  inputs: { script: 'git config --global user.email "svc.pipeline@yourcompany.com" && git config --global user.name "Azure DevOps Pipeline"' }

- task: Bash@3
  displayName: 'Merge, Tag, and Push Release'
  inputs:
    env: { GIT_TOKEN: $(System.AccessToken) }
    script: |
      set -e
      RELEASE_BRANCH="${{ parameters.releaseBranchName }}"
      AUTH_REPO_URL="https://x-token-auth:$(GIT_TOKEN)@${(git config --get remote.origin.url)#https://}"

      git fetch --all --tags

      git checkout main
      git merge "origin/$RELEASE_BRANCH" --no-ff -m "Merge release: $RELEASE_BRANCH"
      git push $AUTH_REPO_URL main

      VERSION_TAG="v${RELEASE_BRANCH#release/}"
      git tag $VERSION_TAG
      git push $AUTH_REPO_URL $VERSION_TAG

      git checkout dev
      git merge "origin/$RELEASE_BRANCH" --no-ff -m "Merge release: $RELEASE_BRANCH into dev"
      git push $AUTH_REPO_URL dev

      git push $AUTH_REPO_URL --delete "$RELEASE_BRANCH"
      echo "Release $VERSION_TAG has been successfully finalized."